C51 COMPILER V9.00   IIC                                                                   06/04/2017 09:23:51 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN iic.OBJ
COMPILER INVOKED BY: D:\新建文件夹\C51\BIN\C51.EXE iic.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "iic.h"
   2          
   3          void delayus(unsigned char x)   //延时函数
   4          {
   5   1              while(x)
   6   1              {
   7   2                      x--;
   8   2              }
   9   1      }
  10          
  11          void iic_start(void)    //开始传输函数
  12          {
  13   1              SDA = 1;                        //先拉高信号线
  14   1              delayus(5);                             
  15   1              SCL = 1;                        //拉高时钟线
  16   1              delayus(5);                             
  17   1              SDA = 0;                        //拉低信号线，表示传输开始
  18   1              delayus(3);                             
  19   1              SCL = 0;                        //拉低时钟线
  20   1      }
  21          
  22          void iic_stop(void)             //结束传输函数
  23          {
  24   1              SCL = 0;                        //拉低时钟线
  25   1              SDA = 0;                        //拉低信号线
  26   1              SCL = 1;                        //拉高时钟线，表示传输结束
  27   1              delayus(5);                     
  28   1              SDA = 1;                        //拉高信号线
  29   1      }
  30          
  31          void iic_ask(bit askbit)        //主机应答函数
  32          {
  33   1              SCL = 0;                                //拉低时钟线
  34   1        if(askbit)                            //如果应答，就将信号线置零
  35   1                      SDA = 0;
  36   1              else                                    //如果不应答，就将信号线置一
  37   1                      SDA = 1;
  38   1              delayus(5);                     
  39   1              SCL = 1;                                //拉高时钟线
  40   1              delayus(5);                     
  41   1              SCL = 0;                                //拉低时钟线
  42   1              SDA = 1;                                //拉高信号线
  43   1              delayus(5);                     
  44   1      }
  45          
  46          unsigned char iic_waitask(void)         //主机等待从机应答信号
  47          {
  48   1              SCL = 0;                                //先拉低时钟线
  49   1              SDA = 1;                                //释放总线，即拉高信号线
  50   1              delayus(5);                     
  51   1              SCL = 1;                                //拉高时钟线
  52   1              delayus(5);                     
  53   1              if(SDA)                                 //查看信号线的电平
  54   1              {
  55   2                      SCL = 0;                        //拉低时钟线；如果信号线为高，即是从机不应答，发送传输结束指令，并返回0
C51 COMPILER V9.00   IIC                                                                   06/04/2017 09:23:51 PAGE 2   

  56   2                      iic_stop();
  57   2                      return 0;
  58   2              }
  59   1              else
  60   1              {
  61   2                      SCL = 0;                        //拉低时钟线；如果信号线为低，即从机应答，返回1
  62   2                      return 1;
  63   2              }
  64   1      }
  65          
  66          void iic_sendbyte(unsigned char byte)                   //主机传输数据到从机函数
  67          {
  68   1              unsigned char i;
  69   1              
  70   1              SCL = 0;                                        //先拉低时钟线
  71   1              for (i=0;i<8;i++)                       //数据由高位到低位传输
  72   1              {
  73   2                      SDA = (byte & 0x80);    //取数据的最高位,后将其移位到最低位，发送到从机
  74   2                      delayus(5);                             
  75   2                      SCL = 1;                                //拉高时钟线，产生一个上升沿
  76   2                      byte <<= 1;                             //数据左移一位
  77   2                      delayus(5);                             
  78   2                      SCL = 0;                                //拉低时钟线
  79   2              }
  80   1      }
  81          
  82          unsigned char iic_readbyte(void)//主机接收从机传输来的数据
  83          {
  84   1              unsigned char i,byte;
  85   1              
  86   1              SCL=0;                                          //先拉低时钟线
  87   1              delayus(5);                                                                             
  88   1              for (i=0;i<8;i++)                       //接收的数据由高位到低位
  89   1               {
  90   2                       SCL = 1;                               //拉高时钟线，产生上升沿
  91   2                       delayus(5);                                                            
  92   2                       byte <<= 1;                    //先将储存数据的变量左移一位
  93   2                       byte |= SDA;               //再和接收到的数据做或运算
  94   2                       SCL = 0;                               //拉低时钟线
  95   2                       delayus(5);                    //拉低时钟线
  96   2               }
  97   1               return byte;                           //返回接收到的数据
  98   1      }
  99          
 100          /******************************************************************************
 101          函数功能：    向AT2402 EEPROM芯片写一个数据
 102          入口参数：              saddr IIC设备的地址； baddr 要写的数据的地址； byte 要写的数据
 103          ******************************************************************************/
 104          void AT2402_SendByte(unsigned char saddr, unsigned char baddr, unsigned char byte)
 105          {
 106   1              unsigned char ask;
 107   1              
 108   1              saddr &= 0xfe;                                  //先将设备地址的最后一位清零，表示是主机要向从机写数据
 109   1              
 110   1              iic_start();                                    //发送开始传输指令
 111   1              iic_sendbyte(saddr);                    //发送设备地址
 112   1              
 113   1              ask = iic_waitask();                    //将从机的应答的情况放到存放应答标志变量
 114   1              if (ask)                                                //如果应答了，继续下面的操作，如果没有，直接结束
 115   1              {
 116   2                      iic_sendbyte(baddr);            //发送要存放数据的地址
 117   2                      ask = iic_waitask();            //将从机的应答的情况放到存放应答标志变量
C51 COMPILER V9.00   IIC                                                                   06/04/2017 09:23:51 PAGE 3   

 118   2                      if (ask)                                        //如果应答了，继续下面的操作，如果没有，直接结束
 119   2                      {
 120   3                              iic_sendbyte(byte);             //发送要写到EEPROM的数据
 121   3                              ask = iic_waitask();    //将从机的应答的情况放到存放应答标志变量
 122   3                      }       
 123   2              }
 124   1              iic_stop();                                             //结束传输
 125   1      }
 126          
 127          unsigned char AT2402_ReceiveByte(unsigned char saddr,unsigned char baddr)
 128          {
 129   1              unsigned char ask, receive_data;
 130   1              
 131   1              saddr &= 0xfe;
 132   1              
 133   1              iic_start();    
 134   1              iic_sendbyte(saddr);
 135   1              
 136   1              ask = 0;
 137   1              ask = iic_waitask();
 138   1              if (ask)
 139   1              {
 140   2                      iic_sendbyte(baddr);
 141   2      
 142   2                      ask = 0;
 143   2                      ask = iic_waitask();
 144   2                      if (ask)
 145   2                      {
 146   3                              iic_start();
 147   3                              saddr |= 0x01;
 148   3                              iic_sendbyte(saddr);
 149   3                              
 150   3                              ask = 0;
 151   3                              ask = iic_waitask();
 152   3                              if (ask)
 153   3                              {
 154   4                                      receive_data = iic_readbyte();
 155   4                                      iic_ask(0);
 156   4                                      iic_stop();
 157   4                                      return receive_data;
 158   4                              }
 159   3                              else 
 160   3                              {
 161   4                                      return 0;
 162   4                              }
 163   3                      }
 164   2                      else
 165   2                      {
 166   3                              return 0;
 167   3                      }
 168   2              }
 169   1              else 
 170   1              {
 171   2                      return 0;
 172   2              }
 173   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    267    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
C51 COMPILER V9.00   IIC                                                                   06/04/2017 09:23:51 PAGE 4   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
